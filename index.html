from flask import Flask, request, jsonify, render_template_files
import requests
import json
import hashlib
import time
import threading
from datetime import datetime, timedelta
from functools import wraps
import os

app = Flask(__name__)

# ==================== Ø§Ù„ØªÙƒÙˆÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ====================
FIREBASE_CONFIG = {
    "apiKey": "AIzaSyDNz-0UL60ZXQdSGte8Tcqz-ciNPYQjLJM",
    "authDomain": "lolaminig-afea4.firebaseapp.com",
    "databaseURL": "https://lolaminig-afea4-default-rtdb.firebaseio.com",
    "projectId": "lolaminig-afea4",
    "storageBucket": "lolaminig-afea4.appspot.com",
    "messagingSenderId": "817050876930",
    "appId": "1:817050876930:web:d2b1a3be37327a397d3b1b"
}

BOT_TOKEN = "8505457388:AAEt1UE0QCiPK7ggv0y9KYS577nwxAEyr7w"
WALLET_ADDRESS = "0xc201f7fb9c7ad0af2944d50719cf86763704ec17"
ADMIN_PASSWORD = "admin123"
BSCSCAN_API_KEY = "YOUR_BSCSCAN_API_KEY"  # ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡ Ù…Ø¬Ø§Ù†Ø§Ù‹

# Ù‚ÙÙ„ Ù„Ù„ØªØ²Ø§Ù…Ù†
deposit_lock = threading.Lock()
processed_transactions = set()

# ==================== Ø¯ÙˆØ§Ù„ Firebase ====================
def firebase_get(path):
    """Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase"""
    url = f"{FIREBASE_CONFIG['databaseURL']}/{path}.json"
    try:
        response = requests.get(url, timeout=10)
        return response.json() if response.status_code == 200 else None
    except:
        return None

def firebase_set(path, data):
    """Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase"""
    url = f"{FIREBASE_CONFIG['databaseURL']}/{path}.json"
    try:
        response = requests.put(url, json=data, timeout=10)
        return response.status_code == 200
    except:
        return False

def firebase_update(path, data):
    """ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase"""
    url = f"{FIREBASE_CONFIG['databaseURL']}/{path}.json"
    try:
        response = requests.patch(url, json=data, timeout=10)
        return response.status_code == 200
    except:
        return False

def firebase_push(path, data):
    """Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯"""
    url = f"{FIREBASE_CONFIG['databaseURL']}/{path}.json"
    try:
        response = requests.post(url, json=data, timeout=10)
        return response.json() if response.status_code == 200 else None
    except:
        return None

def firebase_delete(path):
    """Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    url = f"{FIREBASE_CONFIG['databaseURL']}/{path}.json"
    try:
        response = requests.delete(url, timeout=10)
        return response.status_code == 200
    except:
        return False

# ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
def generate_fingerprint(data):
    """Ø¥Ù†Ø´Ø§Ø¡ Ø¨ØµÙ…Ø© ÙØ±ÙŠØ¯Ø© Ù„Ù„Ø¬Ù‡Ø§Ø²"""
    fingerprint_string = f"{data.get('userAgent', '')}{data.get('screenWidth', '')}{data.get('screenHeight', '')}{data.get('platform', '')}{data.get('timezone', '')}{data.get('language', '')}"
    return hashlib.sha256(fingerprint_string.encode()).hexdigest()

def generate_referral_code(user_id):
    """Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© ÙØ±ÙŠØ¯"""
    return hashlib.md5(str(user_id).encode()).hexdigest()[:8].upper()

def send_telegram_message(chat_id, text, button_text=None, button_url=None):
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± Telegram"""
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {
        "chat_id": chat_id,
        "text": text,
        "parse_mode": "HTML"
    }
    if button_text and button_url:
        payload["reply_markup"] = json.dumps({
            "inline_keyboard": [[{"text": button_text, "url": button_url}]]
        })
    try:
        requests.post(url, json=payload, timeout=10)
    except:
        pass

def get_random_mining_speed():
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø±Ø¹Ø© ØªØ¹Ø¯ÙŠÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©"""
    import random
    return random.uniform(0.00000002, 0.00000056)

# ==================== Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================
@app.route('/')
def index():
    """Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    return render_template_string(get_html_template())

@app.route('/admin')
def admin_panel():
    """Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"""
    return render_template_string(get_admin_html())

# ==================== API Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ====================
@app.route('/api/register', methods=['POST'])
def register_user():
    """ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯"""
    data = request.json
    user_id = data.get('userId')
    username = data.get('username', 'Unknown')
    referrer_code = data.get('referrerCode')
    fingerprint_data = data.get('fingerprint', {})
    
    if not user_id:
        return jsonify({"success": False, "error": "User ID required"})
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    existing_user = firebase_get(f"users/{user_id}")
    if existing_user:
        return jsonify({"success": True, "user": existing_user, "isNew": False})
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
    fingerprint = generate_fingerprint(fingerprint_data)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ØµÙ…Ø©
    fingerprints = firebase_get("fingerprints") or {}
    is_unique_device = fingerprint not in fingerprints.values()
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    referral_code = generate_referral_code(user_id)
    base_speed = get_random_mining_speed()
    
    new_user = {
        "userId": user_id,
        "username": username,
        "balance": 0.0,
        "miningSpeed": base_speed,
        "baseMiningSpeed": base_speed,
        "referralCode": referral_code,
        "referredBy": None,
        "referralCount": 0,
        "totalEarned": 0.0,
        "createdAt": datetime.now().isoformat(),
        "lastActive": datetime.now().isoformat(),
        "isBanned": False,
        "activePlan": None,
        "wordleStats": {
            "correctAnswers": 0,
            "lastPlayed": None,
            "canPlay": False
        }
    }
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
    if referrer_code and is_unique_device:
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙØ­ÙŠÙ„
        users = firebase_get("users") or {}
        for uid, user in users.items():
            if user.get("referralCode") == referrer_code:
                new_user["referredBy"] = uid
                # ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙØ­ÙŠÙ„
                new_referral_count = user.get("referralCount", 0) + 1
                new_speed = user.get("baseMiningSpeed", base_speed) * (1 + (new_referral_count * 0.2))
                firebase_update(f"users/{uid}", {
                    "referralCount": new_referral_count,
                    "miningSpeed": new_speed
                })
                # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…ÙØ­ÙŠÙ„
                send_telegram_message(uid, f"ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ù‚Ø§Ù… Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ!\nâš¡ Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: {new_speed:.10f} LTC/s")
                break
    
    # Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    firebase_set(f"users/{user_id}", new_user)
    
    # Ø­ÙØ¸ Ø§Ù„Ø¨ØµÙ…Ø©
    if is_unique_device:
        firebase_set(f"fingerprints/{user_id}", fingerprint)
    
    return jsonify({"success": True, "user": new_user, "isNew": True})

@app.route('/api/heartbeat', methods=['POST'])
def heartbeat():
    """Ù†Ø¨Ø¶Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ† - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯"""
    data = request.json
    user_id = data.get('userId')
    
    if not user_id:
        return jsonify({"success": False, "error": "User ID required"})
    
    user = firebase_get(f"users/{user_id}")
    if not user or user.get('isBanned'):
        return jsonify({"success": False, "error": "User not found or banned"})
    
    # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    mining_speed = user.get('miningSpeed', 0.00000002)
    current_balance = user.get('balance', 0.0)
    new_balance = current_balance + mining_speed
    total_earned = user.get('totalEarned', 0.0) + mining_speed
    
    # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    firebase_update(f"users/{user_id}", {
        "balance": new_balance,
        "totalEarned": total_earned,
        "lastActive": datetime.now().isoformat()
    })
    
    return jsonify({
        "success": True,
        "balance": new_balance,
        "miningSpeed": mining_speed
    })

@app.route('/api/user/<user_id>', methods=['GET'])
def get_user(user_id):
    """Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    user = firebase_get(f"users/{user_id}")
    if user:
        return jsonify({"success": True, "user": user})
    return jsonify({"success": False, "error": "User not found"})

# ==================== API Ø§Ù„Ù…Ù‡Ø§Ù… ====================
@app.route('/api/tasks', methods=['GET'])
def get_tasks():
    """Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©"""
    tasks = firebase_get("tasks") or {}
    return jsonify({"success": True, "tasks": tasks})

@app.route('/api/tasks/submit', methods=['POST'])
def submit_task():
    """ØªÙ‚Ø¯ÙŠÙ… Ø¥Ø«Ø¨Ø§Øª Ø¥ØªÙ…Ø§Ù… Ù…Ù‡Ù…Ø©"""
    data = request.json
    user_id = data.get('userId')
    task_id = data.get('taskId')
    proof_image = data.get('proofImage')  # Base64
    
    if not all([user_id, task_id, proof_image]):
        return jsonify({"success": False, "error": "Missing data"})
    
    submission = {
        "userId": user_id,
        "taskId": task_id,
        "proofImage": proof_image,
        "submittedAt": datetime.now().isoformat(),
        "status": "pending"
    }
    
    result = firebase_push("taskSubmissions", submission)
    if result:
        return jsonify({"success": True, "submissionId": result.get('name')})
    return jsonify({"success": False, "error": "Failed to submit"})

# ==================== API Ø§Ù„Ù„Ø¹Ø¨Ø© (Wordle) ====================
@app.route('/api/wordle/status', methods=['GET'])
def wordle_status():
    """Ø­Ø§Ù„Ø© Ù„Ø¹Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„ÙŠÙˆÙ…"""
    user_id = request.args.get('userId')
    
    game_config = firebase_get("wordleConfig") or {
        "enabled": False,
        "word": "",
        "letterCount": 5,
        "maxAttempts": 6,
        "reward": 0.001,
        "intervalHours": 5
    }
    
    if not game_config.get('enabled'):
        return jsonify({"success": True, "enabled": False})
    
    user = firebase_get(f"users/{user_id}") if user_id else None
    wordle_stats = user.get('wordleStats', {}) if user else {}
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨
    can_play = wordle_stats.get('correctAnswers', 0) >= 3
    last_played = wordle_stats.get('lastPlayed')
    
    if last_played:
        last_time = datetime.fromisoformat(last_played)
        next_play = last_time + timedelta(hours=game_config.get('intervalHours', 5))
        can_play = can_play and datetime.now() >= next_play
    
    return jsonify({
        "success": True,
        "enabled": True,
        "letterCount": game_config.get('letterCount'),
        "maxAttempts": game_config.get('maxAttempts'),
        "reward": game_config.get('reward'),
        "canPlay": can_play,
        "correctAnswers": wordle_stats.get('correctAnswers', 0)
    })

@app.route('/api/wordle/guess', methods=['POST'])
def wordle_guess():
    """ØªØ®Ù…ÙŠÙ† ÙƒÙ„Ù…Ø©"""
    data = request.json
    user_id = data.get('userId')
    guess = data.get('guess', '').upper()
    
    game_config = firebase_get("wordleConfig") or {}
    correct_word = game_config.get('word', '').upper()
    
    if not correct_word:
        return jsonify({"success": False, "error": "No active game"})
    
    if len(guess) != len(correct_word):
        return jsonify({"success": False, "error": "Invalid word length"})
    
    # ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ®Ù…ÙŠÙ†
    result = []
    for i, letter in enumerate(guess):
        if letter == correct_word[i]:
            result.append({"letter": letter, "status": "correct"})
        elif letter in correct_word:
            result.append({"letter": letter, "status": "present"})
        else:
            result.append({"letter": letter, "status": "absent"})
    
    is_correct = guess == correct_word
    
    if is_correct and user_id:
        # ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ…Ù†Ø­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
        user = firebase_get(f"users/{user_id}")
        if user:
            reward = game_config.get('reward', 0.001)
            new_balance = user.get('balance', 0) + reward
            wordle_stats = user.get('wordleStats', {})
            wordle_stats['correctAnswers'] = wordle_stats.get('correctAnswers', 0) + 1
            wordle_stats['lastPlayed'] = datetime.now().isoformat()
            
            firebase_update(f"users/{user_id}", {
                "balance": new_balance,
                "wordleStats": wordle_stats
            })
    
    return jsonify({
        "success": True,
        "result": result,
        "isCorrect": is_correct
    })

# ==================== API Ø§Ù„Ù…Ø­ÙØ¸Ø© ====================
@app.route('/api/withdraw', methods=['POST'])
def request_withdrawal():
    """Ø·Ù„Ø¨ Ø³Ø­Ø¨"""
    data = request.json
    user_id = data.get('userId')
    amount = float(data.get('amount', 0))
    wallet_address = data.get('walletAddress')
    
    if not all([user_id, amount, wallet_address]):
        return jsonify({"success": False, "error": "Missing data"})
    
    if amount < 0.001:
        return jsonify({"success": False, "error": "Minimum withdrawal is 0.001 LTC"})
    
    user = firebase_get(f"users/{user_id}")
    if not user:
        return jsonify({"success": False, "error": "User not found"})
    
    if user.get('balance', 0) < amount:
        return jsonify({"success": False, "error": "Insufficient balance"})
    
    # Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº
    new_balance = user.get('balance', 0) - amount
    firebase_update(f"users/{user_id}", {"balance": new_balance})
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨
    withdrawal = {
        "userId": user_id,
        "amount": amount,
        "walletAddress": wallet_address,
        "status": "pending",
        "createdAt": datetime.now().isoformat()
    }
    
    firebase_push("withdrawals", withdrawal)
    
    return jsonify({"success": True, "newBalance": new_balance})

@app.route('/api/deposit/address', methods=['GET'])
def get_deposit_address():
    """Ø¬Ù„Ø¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹"""
    return jsonify({
        "success": True,
        "address": WALLET_ADDRESS,
        "network": "BEP20 (BSC)"
    })

# ==================== API Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ====================
@app.route('/api/admin/login', methods=['POST'])
def admin_login():
    """ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†"""
    data = request.json
    password = data.get('password')
    
    if password == ADMIN_PASSWORD:
        return jsonify({"success": True})
    return jsonify({"success": False, "error": "Invalid password"})

@app.route('/api/admin/users', methods=['GET'])
def admin_get_users():
    """Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    users = firebase_get("users") or {}
    return jsonify({"success": True, "users": users})

@app.route('/api/admin/user/<user_id>/ban', methods=['POST'])
def admin_ban_user(user_id):
    """Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…"""
    firebase_update(f"users/{user_id}", {"isBanned": True})
    return jsonify({"success": True})

@app.route('/api/admin/user/<user_id>/unban', methods=['POST'])
def admin_unban_user(user_id):
    """Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…"""
    firebase_update(f"users/{user_id}", {"isBanned": False})
    return jsonify({"success": True})

@app.route('/api/admin/user/<user_id>', methods=['DELETE'])
def admin_delete_user(user_id):
    """Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…"""
    firebase_delete(f"users/{user_id}")
    return jsonify({"success": True})

@app.route('/api/admin/broadcast', methods=['POST'])
def admin_broadcast():
    """Ø¨Ø« Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    data = request.json
    message = data.get('message')
    button_text = data.get('buttonText')
    button_url = data.get('buttonUrl')
    
    if not message:
        return jsonify({"success": False, "error": "Message required"})
    
    users = firebase_get("users") or {}
    sent_count = 0
    
    for user_id in users.keys():
        try:
            send_telegram_message(user_id, message, button_text, button_url)
            sent_count += 1
        except:
            pass
    
    return jsonify({"success": True, "sentCount": sent_count})

@app.route('/api/admin/tasks', methods=['POST'])
def admin_add_task():
    """Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©"""
    data = request.json
    task = {
        "title": data.get('title'),
        "description": data.get('description'),
        "url": data.get('url'),
        "reward": float(data.get('reward', 0)),
        "createdAt": datetime.now().isoformat(),
        "isActive": True
    }
    
    result = firebase_push("tasks", task)
    if result:
        return jsonify({"success": True, "taskId": result.get('name')})
    return jsonify({"success": False})

@app.route('/api/admin/tasks/<task_id>', methods=['DELETE'])
def admin_delete_task(task_id):
    """Ø­Ø°Ù Ù…Ù‡Ù…Ø©"""
    firebase_delete(f"tasks/{task_id}")
    return jsonify({"success": True})

@app.route('/api/admin/submissions', methods=['GET'])
def admin_get_submissions():
    """Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©"""
    submissions = firebase_get("taskSubmissions") or {}
    pending = {k: v for k, v in submissions.items() if v.get('status') == 'pending'}
    return jsonify({"success": True, "submissions": pending})

@app.route('/api/admin/submissions/<submission_id>/approve', methods=['POST'])
def admin_approve_submission(submission_id):
    """Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ù…Ù‡Ù…Ø©"""
    submission = firebase_get(f"taskSubmissions/{submission_id}")
    if not submission:
        return jsonify({"success": False, "error": "Submission not found"})
    
    task = firebase_get(f"tasks/{submission.get('taskId')}")
    if task:
        user = firebase_get(f"users/{submission.get('userId')}")
        if user:
            new_balance = user.get('balance', 0) + task.get('reward', 0)
            firebase_update(f"users/{submission.get('userId')}", {"balance": new_balance})
    
    firebase_update(f"taskSubmissions/{submission_id}", {"status": "approved"})
    return jsonify({"success": True})

@app.route('/api/admin/submissions/<submission_id>/reject', methods=['POST'])
def admin_reject_submission(submission_id):
    """Ø±ÙØ¶ Ø·Ù„Ø¨ Ù…Ù‡Ù…Ø©"""
    firebase_update(f"taskSubmissions/{submission_id}", {"status": "rejected"})
    return jsonify({"success": True})

@app.route('/api/admin/wordle', methods=['POST'])
def admin_update_wordle():
    """ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©"""
    data = request.json
    config = {
        "enabled": data.get('enabled', False),
        "word": data.get('word', '').upper(),
        "letterCount": int(data.get('letterCount', 5)),
        "maxAttempts": int(data.get('maxAttempts', 6)),
        "reward": float(data.get('reward', 0.001)),
        "intervalHours": int(data.get('intervalHours', 5))
    }
    
    firebase_set("wordleConfig", config)
    return jsonify({"success": True})

@app.route('/api/admin/wordle', methods=['GET'])
def admin_get_wordle():
    """Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©"""
    config = firebase_get("wordleConfig") or {}
    return jsonify({"success": True, "config": config})

@app.route('/api/admin/plans', methods=['GET'])
def admin_get_plans():
    """Ø¬Ù„Ø¨ Ø§Ù„Ø®Ø·Ø·"""
    plans = firebase_get("plans") or {}
    return jsonify({"success": True, "plans": plans})

@app.route('/api/admin/plans', methods=['POST'])
def admin_add_plan():
    """Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©"""
    data = request.json
    plan = {
        "name": data.get('name'),
        "duration": int(data.get('duration', 30)),
        "speedMultiplier": float(data.get('speedMultiplier', 2)),
        "price": float(data.get('price', 10)),
        "isActive": True
    }
    
    result = firebase_push("plans", plan)
    if result:
        return jsonify({"success": True, "planId": result.get('name')})
    return jsonify({"success": False})

@app.route('/api/admin/withdrawals', methods=['GET'])
def admin_get_withdrawals():
    """Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨"""
    withdrawals = firebase_get("withdrawals") or {}
    return jsonify({"success": True, "withdrawals": withdrawals})

@app.route('/api/admin/withdrawals/<withdrawal_id>/approve', methods=['POST'])
def admin_approve_withdrawal(withdrawal_id):
    """Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø³Ø­Ø¨"""
    firebase_update(f"withdrawals/{withdrawal_id}", {"status": "approved"})
    return jsonify({"success": True})

@app.route('/api/admin/withdrawals/<withdrawal_id>/reject', methods=['POST'])
def admin_reject_withdrawal(withdrawal_id):
    """Ø±ÙØ¶ Ø·Ù„Ø¨ Ø³Ø­Ø¨ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¨Ù„Øº"""
    withdrawal = firebase_get(f"withdrawals/{withdrawal_id}")
    if withdrawal:
        user = firebase_get(f"users/{withdrawal.get('userId')}")
        if user:
            new_balance = user.get('balance', 0) + withdrawal.get('amount', 0)
            firebase_update(f"users/{withdrawal.get('userId')}", {"balance": new_balance})
    
    firebase_update(f"withdrawals/{withdrawal_id}", {"status": "rejected"})
    return jsonify({"success": True})

@app.route('/api/admin/stats', methods=['GET'])
def admin_get_stats():
    """Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©"""
    users = firebase_get("users") or {}
    withdrawals = firebase_get("withdrawals") or {}
    
    total_users = len(users)
    total_balance = sum(u.get('balance', 0) for u in users.values())
    pending_withdrawals = len([w for w in withdrawals.values() if w.get('status') == 'pending'])
    
    return jsonify({
        "success": True,
        "stats": {
            "totalUsers": total_users,
            "totalBalance": total_balance,
            "pendingWithdrawals": pending_withdrawals
        }
    })

# ==================== Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª ====================
def check_deposits():
    """ÙØ­Øµ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"""
    global processed_transactions
    
    url = f"https://api.bscscan.com/api?module=account&action=tokentx&address={WALLET_ADDRESS}&sort=desc&apikey={BSCSCAN_API_KEY}"
    
    try:
        response = requests.get(url, timeout=10)
        data = response.json()
        
        if data.get('status') == '1':
            transactions = data.get('result', [])[:20]
            
            for tx in transactions:
                tx_hash = tx.get('hash')
                
                if tx_hash in processed_transactions:
                    continue
                
                with deposit_lock:
                    if tx_hash in processed_transactions:
                        continue
                    
                    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹
                    value = int(tx.get('value', 0)) / (10 ** int(tx.get('tokenDecimal', 18)))
                    from_address = tx.get('from', '').lower()
                    
                    # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©
                    users = firebase_get("users") or {}
                    for user_id, user in users.items():
                        if user.get('depositAddress', '').lower() == from_address:
                            # ØªÙØ¹ÙŠÙ„ Ø®Ø·Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº
                            plans = firebase_get("plans") or {}
                            for plan_id, plan in plans.items():
                                if plan.get('price') == value:
                                    # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©
                                    new_speed = user.get('baseMiningSpeed', 0.00000002) * plan.get('speedMultiplier', 1)
                                    expiry = datetime.now() + timedelta(days=plan.get('duration', 30))
                                    
                                    firebase_update(f"users/{user_id}", {
                                        "miningSpeed": new_speed,
                                        "activePlan": {
                                            "planId": plan_id,
                                            "expiresAt": expiry.isoformat()
                                        }
                                    })
                                    
                                    send_telegram_message(user_id, f"ğŸ‰ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø·Ø© {plan.get('name')}!\nâš¡ Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: {new_speed:.10f} LTC/s")
                                    break
                            break
                    
                    processed_transactions.add(tx_hash)
    except Exception as e:
        print(f"Error checking deposits: {e}")

# ==================== Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ====================
def get_html_template():
    """Ù‚Ø§Ù„Ø¨ HTML Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"""
    return '''<!DOCTYPE html>
<!-- Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØªØ§Ù„ÙŠ -->
'''

def get_admin_html():
    """Ù‚Ø§Ù„Ø¨ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"""
    return '''<!DOCTYPE html>
<!-- Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ ÙƒÙˆØ¯ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
'''

# ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
def start_deposit_checker():
    import time
    while True:
        check_deposits()
        time.sleep(60)

# Ø¨Ø¯Ø¡ Ø§Ù„Ø®ÙŠØ· ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
deposit_thread = threading.Thread(target=start_deposit_checker, daemon=True)
deposit_thread.start()

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
