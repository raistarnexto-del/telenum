<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TeleNum - منصة الأرقام الذهبية</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #0088cc;
            --primary-dark: #006699;
            --primary-light: #e6f4fa;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f4f6f9;
            --bg-secondary: #ffffff;
            --card: #ffffff;
            --text: #1f2937;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.1);
            --radius: 16px;
            --radius-sm: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

        /* Loading */
        .loading-screen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; }
        .loading-screen.hidden { display: none; }
        .loading-logo { font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Header */
        .header { background: var(--bg-secondary); padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        .header-content { max-width: 480px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .balance-box { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 0.5rem 1.2rem; border-radius: 30px; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,136,204,0.3); transition: transform 0.2s; }
        .balance-box:hover { transform: scale(1.05); }

        /* Container */
        .container { max-width: 480px; margin: 0 auto; padding: 1rem; padding-bottom: 90px; }

        /* Pages */
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Stats */
        .stats-row { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; }
        .stat-box { flex: 1; background: var(--card); border-radius: var(--radius); padding: 1.2rem; text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border); transition: transform 0.2s; }
        .stat-box:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem; }

        /* Section */
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .section-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
        .section-title i { color: var(--primary); background: var(--primary-light); padding: 0.4rem; border-radius: 8px; }

        /* Search */
        .search-input { width: 100%; padding: 1rem 1rem 1rem 3rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.95rem; font-family: inherit; background: var(--card); margin-bottom: 1rem; transition: all 0.2s; }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .search-wrapper { position: relative; }
        .search-wrapper i { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }

        /* Country Card */
        .country-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .country-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; transition: all 0.3s ease; }
        .country-card:hover { border-color: var(--primary); box-shadow: var(--shadow-hover); transform: translateX(-5px); }
        .country-card.disabled { opacity: 0.5; pointer-events: none; }
        .country-flag { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); }
        .country-info { flex: 1; }
        .country-name { font-weight: 600; font-size: 0.95rem; }
        .country-meta { font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem; margin-top: 0.2rem; }
        .country-stock { color: var(--success); font-weight: 600; }
        .country-stock.low { color: var(--warning); }
        .country-stock.empty { color: var(--danger); }
        .country-price { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 700; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,136,204,0.3); }

        /* Buttons */
        .btn { width: 100%; padding: 0.875rem; border: none; border-radius: var(--radius-sm); font-size: 0.95rem; font-weight: 600; font-family: inherit; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 10px rgba(0,136,204,0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,136,204,0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); color: white; }
        .btn-sm { padding: 0.5rem 1rem; width: auto; font-size: 0.85rem; }
        .btn-loading::after { content: ''; width: 16px; height: 16px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 0.5rem; }

        /* Form */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .form-input { width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.95rem; font-family: inherit; background: var(--card); transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .form-hint { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; }

        /* Alert */
        .alert { padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1rem; display: flex; align-items: flex-start; gap: 0.75rem; font-size: 0.9rem; border-left: 4px solid; }
        .alert i { margin-top: 2px; }
        .alert-info { background: #e0f2fe; color: #0369a1; border-color: #0369a1; }
        .alert-success { background: #dcfce7; color: #15803d; border-color: #15803d; }
        .alert-warning { background: #fef3c7; color: #92400e; border-color: #92400e; }
        .alert-danger { background: #fee2e2; color: #dc2626; border-color: #dc2626; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--card); border-radius: var(--radius); width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; animation: modalIn 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--bg); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text-secondary); }
        .modal-close:hover { background: var(--danger); color: white; }
        .modal-body { padding: 1.25rem; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--border); z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .nav-items { max-width: 480px; margin: 0 auto; display: flex; justify-content: space-around; padding: 0.5rem 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; padding: 0.4rem 0.75rem; color: var(--text-secondary); text-decoration: none; border: none; background: none; cursor: pointer; font-family: inherit; border-radius: 12px; transition: all 0.2s; }
        .nav-item.active { color: var(--primary); background: var(--primary-light); }
        .nav-item i { font-size: 1.2rem; }
        .nav-item span { font-size: 0.7rem; font-weight: 600; }

        /* Auth */
        .auth-container { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
        .auth-logo { font-size: 2.5rem; font-weight: 800; color: white; margin-bottom: 0.5rem; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .auth-subtitle { color: rgba(255,255,255,0.9); margin-bottom: 2rem; text-align: center; }
        .auth-card { width: 100%; max-width: 380px; background: var(--card); border-radius: var(--radius); padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .auth-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; background: var(--bg); padding: 5px; border-radius: var(--radius-sm); }
        .auth-tab { flex: 1; padding: 0.75rem; border: none; border-radius: 8px; background: transparent; font-weight: 600; cursor: pointer; font-family: inherit; color: var(--text-secondary); transition: all 0.2s; }
        .auth-tab.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,136,204,0.3); }
        .auth-form { display: none; }
        .auth-form.active { display: block; animation: fadeIn 0.3s ease; }

        /* Purchase Card */
        .purchase-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 0.75rem; transition: all 0.2s; }
        .purchase-card:hover { box-shadow: var(--shadow); }
        .purchase-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .purchase-phone { font-size: 1.1rem; font-weight: 700; direction: ltr; flex: 1; color: var(--primary); }
        .purchase-status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .purchase-status.active { background: #dcfce7; color: #15803d; }
        .purchase-status.completed { background: #e0f2fe; color: #0369a1; }

        /* Messages */
        .message-item { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--bg); border-radius: var(--radius-sm); margin-bottom: 0.5rem; border-left: 3px solid var(--primary); }
        .message-code { font-size: 1.25rem; font-weight: 800; color: var(--primary); letter-spacing: 2px; flex: 1; }

        /* Wallet */
        .wallet-card { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 10px 20px rgba(0,136,204,0.3); position: relative; overflow: hidden; }
        .wallet-card::after { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none; }
        .wallet-label { font-size: 0.9rem; opacity: 0.9; }
        .wallet-balance { font-size: 2.5rem; font-weight: 800; margin-top: 0.25rem; position: relative; }
        .wallet-actions { display: flex; gap: 0.75rem; margin-top: 1.25rem; position: relative; }
        .wallet-btn { flex: 1; padding: 0.75rem; border-radius: var(--radius-sm); border: none; background: rgba(255,255,255,0.2); color: white; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; font-family: inherit; transition: all 0.2s; backdrop-filter: blur(5px); }
        .wallet-btn:hover { background: rgba(255,255,255,0.3); }

        /* Referral */
        .referral-box { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; }
        .referral-code { background: var(--bg); border: 1px dashed var(--primary); border-radius: var(--radius-sm); padding: 0.75rem; display: flex; align-items: center; justify-content: space-between; margin: 0.75rem 0; }
        .referral-code span { font-size: 1.25rem; font-weight: 700; letter-spacing: 2px; color: var(--primary); }
        .referral-stats { display: flex; gap: 1rem; }
        .referral-stat { flex: 1; text-align: center; }
        .referral-stat-value { font-size: 1.25rem; font-weight: 800; color: var(--primary); }
        .referral-stat-label { font-size: 0.8rem; color: var(--text-secondary); }

        /* Toast */
        .toast-container { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 360px; }
        .toast { background: var(--text); color: white; padding: 0.875rem 1rem; border-radius: var(--radius-sm); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; animation: toastIn 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }

        /* Settings */
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .settings-item:hover { background: var(--bg); }
        .settings-info { display: flex; align-items: center; gap: 0.75rem; }
        .settings-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); }

        /* Admin */
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem; }
        .admin-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .admin-card:hover { background: var(--bg); transform: translateY(-3px); box-shadow: var(--shadow-hover); border-color: var(--primary); }
        .admin-card i { font-size: 1.5rem; color: var(--primary); margin-bottom: 0.5rem; }
        .admin-card h3 { font-size: 0.85rem; margin-bottom: 0.25rem; color: var(--text-secondary); }
        .admin-card span { font-size: 1.5rem; font-weight: 800; color: var(--text); }

        /* Empty */
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }

        /* Deposit */
        .deposit-address { background: var(--bg); border: 1px dashed var(--border); border-radius: var(--radius-sm); padding: 0.75rem; font-family: monospace; font-size: 0.8rem; word-break: break-all; text-align: center; margin: 1rem 0; }
        .network-badge { display: inline-flex; align-items: center; gap: 0.5rem; background: var(--warning); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem; }

        /* Confirm Box */
        .confirm-box { background: var(--bg); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; }
        .confirm-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
        .confirm-row:last-child { border: none; }
        .confirm-label { color: var(--text-secondary); }
        .confirm-value { font-weight: 700; }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo"><i class="fab fa-telegram"></i> TeleNum</div>
        <div class="spinner"></div>
    </div>

    <!-- Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auth Page -->
    <div id="authPage" style="display: none;">
        <div class="auth-container">
            <div class="auth-logo"><i class="fab fa-telegram"></i> TeleNum</div>
            <p class="auth-subtitle">منصة بيع وشراء أرقام تيليجرام الموثوقة</p>
            
            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">دخول</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">تسجيل</button>
                </div>

                <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">البريد الإلكتروني</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="example@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">كلمة المرور</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                    </button>
                </form>

                <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label">اسم المستخدم</label>
                        <input type="text" class="form-input" id="regUsername" placeholder="اسمك" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">البريد الإلكتروني</label>
                        <input type="email" class="form-input" id="regEmail" placeholder="example@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">كلمة المرور</label>
                        <input type="password" class="form-input" id="regPassword" placeholder="6 أحرف على الأقل" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">كود الإحالة (اختياري)</label>
                        <input type="text" class="form-input" id="regReferral" placeholder="XXXXXX">
                    </div>
                    <button type="submit" class="btn btn-primary" id="registerBtn">
                        <i class="fas fa-user-plus"></i> إنشاء حساب
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-content">
                <div class="logo"><i class="fab fa-telegram"></i> TeleNum</div>
                <div class="balance-box" onclick="showPage('wallet')">
                    <i class="fas fa-wallet"></i>
                    <span id="headerBalance">$0.00</span>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Home -->
            <div class="page active" id="homePage">
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-value" id="statNumbers">0</div>
                        <div class="stat-label">رقم متاح</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statCountries">0</div>
                        <div class="stat-label">دولة</div>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="showPage('buy')" style="flex: 1;">
                        <i class="fas fa-shopping-cart"></i> شراء
                    </button>
                    <button class="btn btn-secondary" onclick="showPage('sell')" style="flex: 1;">
                        <i class="fas fa-dollar-sign"></i> بيع
                    </button>
                </div>

                <div class="section-header">
                    <div class="section-title"><i class="fas fa-fire"></i> الدول المتاحة</div>
                </div>

                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" id="searchCountry" placeholder="ابحث عن دولة..." oninput="filterCountries()">
                </div>

                <div class="country-list" id="countriesList"></div>
            </div>

            <!-- Buy -->
            <div class="page" id="buyPage">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-shopping-cart"></i> شراء رقم</div>
                </div>

                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" id="searchBuy" placeholder="ابحث..." oninput="filterBuyCountries()">
                </div>

                <div class="country-list" id="buyCountriesList"></div>
            </div>

            <!-- Sell -->
            <div class="page" id="sellPage">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-dollar-sign"></i> بيع رقم</div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>تنبيه مهم!</strong><br>
                        يجب تسجيل الخروج من تيليجرام على جميع الأجهزة الأخرى قبل البيع، وإلا لن يُحتسب الرصيد.
                    </div>
                </div>

                <div id="sellStep1">
                    <div class="form-group">
                        <label class="form-label">رقم الهاتف مع كود الدولة</label>
                        <input type="tel" class="form-input" id="sellPhone" placeholder="+966501234567" dir="ltr" style="text-align: left;">
                        <p class="form-hint">مثال: +966501234567</p>
                    </div>
                    <button class="btn btn-primary" onclick="sellSendCode()" id="sellSendBtn">
                        <i class="fas fa-paper-plane"></i> إرسال كود التحقق
                    </button>
                </div>

                <div id="sellStep2" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>تم إرسال الكود! <span id="sellInfo"></span></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">كود التحقق</label>
                        <input type="text" class="form-input" id="sellCode" placeholder="12345" dir="ltr" style="text-align: center; font-size: 1.5rem; letter-spacing: 8px;">
                    </div>

                    <div class="form-group" id="sell2FABox" style="display: none;">
                        <label class="form-label">كلمة مرور التحقق بخطوتين</label>
                        <input type="password" class="form-input" id="sell2FA" placeholder="كلمة المرور">
                    </div>

                    <button class="btn btn-success" onclick="sellVerify()" id="sellVerifyBtn">
                        <i class="fas fa-check"></i> تأكيد البيع
                    </button>
                </div>
            </div>

            <!-- Numbers -->
            <div class="page" id="numbersPage">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-list"></i> أرقامي</div>
                </div>
                <div id="myNumbersList"></div>
            </div>

            <!-- Wallet -->
            <div class="page" id="walletPage">
                <div class="wallet-card">
                    <div class="wallet-label">رصيدك</div>
                    <div class="wallet-balance">$<span id="walletBalance">0.00</span></div>
                    <div class="wallet-actions">
                        <button class="wallet-btn" onclick="openModal('depositModal')">
                            <i class="fas fa-plus"></i> إيداع
                        </button>
                        <button class="wallet-btn" onclick="openModal('withdrawModal')">
                            <i class="fas fa-minus"></i> سحب
                        </button>
                    </div>
                </div>

                <div class="referral-box">
                    <div class="section-title"><i class="fas fa-users"></i> الإحالات</div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">احصل على $0.05 لكل صديق</p>
                    
                    <div class="referral-code">
                        <span id="myReferralCode">-----</span>
                        <button class="btn btn-sm btn-secondary" onclick="copyReferral()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>

                    <div class="referral-stats">
                        <div class="referral-stat">
                            <div class="referral-stat-value" id="referralCount">0</div>
                            <div class="referral-stat-label">إحالة</div>
                        </div>
                        <div class="referral-stat">
                            <div class="referral-stat-value">$<span id="referralEarnings">0.00</span></div>
                            <div class="referral-stat-label">الأرباح</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="page" id="settingsPage">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-cog"></i> الإعدادات</div>
                </div>

                <div class="settings-item" id="adminBtn" style="display: none;" onclick="showPage('admin')">
                    <div class="settings-info">
                        <div class="settings-icon"><i class="fas fa-shield-alt"></i></div>
                        <span style="font-weight: 700; color: var(--primary);">لوحة التحكم</span>
                    </div>
                    <i class="fas fa-chevron-left"></i>
                </div>

                <div class="settings-item">
                    <div class="settings-info">
                        <div class="settings-icon"><i class="fas fa-user"></i></div>
                        <div>
                            <div id="settingsName">المستخدم</div>
                            <small style="color: var(--text-secondary);" id="settingsEmail">email</small>
                        </div>
                    </div>
                </div>

                <div class="settings-item" onclick="showDeviceInfo()">
                    <div class="settings-info">
                        <div class="settings-icon"><i class="fas fa-mobile-alt"></i></div>
                        <span>معلومات الجهاز</span>
                    </div>
                    <i class="fas fa-chevron-left"></i>
                </div>
            </div>

            <!-- Admin -->
            <div class="page" id="adminPage">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-shield-alt"></i> لوحة التحكم</div>
                </div>

                <div class="admin-grid" id="adminStats">
                    <div class="admin-card" onclick="loadAdminSection('users')">
                        <i class="fas fa-users"></i>
                        <h3>المستخدمين</h3>
                        <span id="adminUsers">0</span>
                    </div>
                    <div class="admin-card" onclick="loadAdminSection('numbers')">
                        <i class="fas fa-phone"></i>
                        <h3>الأرقام</h3>
                        <span id="adminNumbers">0</span>
                    </div>
                    <div class="admin-card" onclick="loadAdminSection('sells')">
                        <i class="fas fa-clock"></i>
                        <h3>طلبات البيع</h3>
                        <span id="adminSells">0</span>
                    </div>
                    <div class="admin-card" onclick="loadAdminSection('withdrawals')">
                        <i class="fas fa-money-bill"></i>
                        <h3>طلبات السحب</h3>
                        <span id="adminWithdrawals">0</span>
                    </div>
                    <div class="admin-card" onclick="loadAdminSection('deposits')">
                        <i class="fas fa-plus-circle"></i>
                        <h3>إيداعات معلقة</h3>
                        <span id="adminDeposits">0</span>
                    </div>
                    <div class="admin-card" onclick="loadAdminSection('addNumber')">
                        <i class="fas fa-plus"></i>
                        <h3>إضافة رقم</h3>
                        <span>+</span>
                    </div>
                </div>

                <button class="btn btn-danger" onclick="confirmDeleteAll()" style="margin-top: 1rem;">
                    <i class="fas fa-trash"></i> حذف جميع البيانات
                </button>

                <div id="adminContent"></div>
            </div>
        </div>

        <!-- Bottom Nav -->
        <nav class="bottom-nav">
            <div class="nav-items">
                <button class="nav-item active" onclick="showPage('home')">
                    <i class="fas fa-home"></i><span>الرئيسية</span>
                </button>
                <button class="nav-item" onclick="showPage('buy')">
                    <i class="fas fa-shopping-cart"></i><span>شراء</span>
                </button>
                <button class="nav-item" onclick="showPage('sell')">
                    <i class="fas fa-dollar-sign"></i><span>بيع</span>
                </button>
                <button class="nav-item" onclick="showPage('numbers')">
                    <i class="fas fa-list"></i><span>أرقامي</span>
                </button>
                <button class="nav-item" onclick="showPage('wallet')">
                    <i class="fas fa-wallet"></i><span>المحفظة</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Buy Modal -->
    <div class="modal-overlay" id="buyModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">تأكيد الشراء</h3>
                <button class="modal-close" onclick="closeModal('buyModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 1rem;">
                    <img id="buyFlag" src="" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--border);">
                    <h3 id="buyCountryName" style="margin-top: 0.5rem;"></h3>
                    <p id="buyCountryCode" style="color: var(--text-secondary);"></p>
                </div>

                <div class="confirm-box">
                    <div class="confirm-row">
                        <span class="confirm-label">السعر</span>
                        <span class="confirm-value" id="buyPrice">$0.00</span>
                    </div>
                    <div class="confirm-row">
                        <span class="confirm-label">رصيدك</span>
                        <span class="confirm-value" id="buyBalance">$0.00</span>
                    </div>
                </div>

                <button class="btn btn-primary" id="confirmBuyBtn" onclick="confirmBuy()">
                    <i class="fas fa-check"></i> تأكيد الشراء
                </button>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal-overlay" id="depositModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">إيداع</h3>
                <button class="modal-close" onclick="closeModal('depositModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div><strong>أرسل USDT على شبكة BEP20 فقط!</strong></div>
                </div>

                <p style="text-align: center; margin-bottom: 0.5rem;">عنوان الإيداع:</p>
                <div class="deposit-address" id="depositAddr">جاري التحميل...</div>
                <button class="btn btn-secondary" onclick="copyDeposit()" style="margin-bottom: 1rem;">
                    <i class="fas fa-copy"></i> نسخ العنوان
                </button>

                <hr style="border: none; border-top: 1px solid var(--border); margin: 1rem 0;">

                <div class="form-group">
                    <label class="form-label">TXID المعاملة</label>
                    <input type="text" class="form-input" id="depositTxid" placeholder="0x..." dir="ltr">
                </div>
                <button class="btn btn-primary" onclick="submitDeposit()" id="depositBtn">
                    <i class="fas fa-check"></i> تأكيد الإيداع
                </button>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal-overlay" id="withdrawModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">سحب</h3>
                <button class="modal-close" onclick="closeModal('withdrawModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="confirm-box" style="text-align: center;">
                    <small>الرصيد المتاح</small>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">$<span id="withdrawBalance">0.00</span></div>
                </div>

                <div class="form-group">
                    <label class="form-label">المبلغ (الحد الأدنى $3)</label>
                    <input type="number" class="form-input" id="withdrawAmount" placeholder="0.00" step="0.01" min="3">
                </div>
                <div class="form-group">
                    <label class="form-label">عنوان USDT (BEP20)</label>
                    <input type="text" class="form-input" id="withdrawAddress" placeholder="0x..." dir="ltr">
                </div>
                <button class="btn btn-primary" onclick="submitWithdraw()" id="withdrawBtn">
                    <i class="fas fa-paper-plane"></i> طلب السحب
                </button>
            </div>
        </div>
    </div>

    <!-- Number Modal -->
    <div class="modal-overlay" id="numberModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">رسائل الرقم</h3>
                <button class="modal-close" onclick="closeModal('numberModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="numberModalBody"></div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--danger);">⚠️ تأكيد الحذف</h3>
                <button class="modal-close" onclick="closeModal('deleteModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>تحذير!</strong><br>
                        سيتم حذف جميع البيانات نهائياً ولا يمكن استعادتها!
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">اكتب "DELETE" للتأكيد</label>
                    <input type="text" class="form-input" id="deleteConfirmInput" placeholder="DELETE">
                </div>
                <button class="btn btn-danger" onclick="executeDeleteAll()">
                    <i class="fas fa-trash"></i> حذف نهائي
                </button>
            </div>
        </div>
    </div>

<script>
// Config
const API = '';
let user = null;
let countries = [];
let selectedCountry = null;
let selectedPurchaseId = null;
let sellPhoneNumber = '';

// Device ID - ثابت ولا يتغير
const deviceId = localStorage.getItem('deviceId') || (() => {
    const id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('deviceId', id);
    return id;
})();

// Fingerprint
async function getFingerprint() {
    const fp = {
        deviceId,
        ua: navigator.userAgent,
        lang: navigator.language,
        platform: navigator.platform,
        cores: navigator.hardwareConcurrency || 0,
        memory: navigator.deviceMemory || 0,
        screen: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        touch: navigator.maxTouchPoints || 0
    };
    
    try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('fp', 2, 2);
        fp.canvas = canvas.toDataURL().slice(-20);
    } catch(e) {}
    
    return fp;
}

// Toast
function toast(msg, type = 'success') {
    const div = document.createElement('div');
    div.className = `toast ${type}`;
    div.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'exclamation'}-circle"></i> ${msg}`;
    document.getElementById('toastContainer').appendChild(div);
    setTimeout(() => div.remove(), 3500);
}

// API
async function api(endpoint, method = 'GET', data = null) {
    const headers = { 'Content-Type': 'application/json' };
    if (user?.token) headers['Authorization'] = `Bearer ${user.token}`;
    
    const config = { method, headers };
    if (data) {
        const fp = await getFingerprint();
        config.body = JSON.stringify({ ...data, deviceId, fingerprint: fp });
    }
    
    try {
        const res = await fetch(`${API}${endpoint}`, config);
        return await res.json();
    } catch(e) {
        return { success: false, error: 'خطأ في الاتصال' };
    }
}

// Auth
function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach((t, i) => {
        t.classList.toggle('active', (tab === 'login' && i === 0) || (tab === 'register' && i === 1));
    });
    document.getElementById('loginForm').classList.toggle('active', tab === 'login');
    document.getElementById('registerForm').classList.toggle('active', tab === 'register');
}

async function handleLogin(e) {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    btn.classList.add('btn-loading');
    btn.disabled = true;
    
    const res = await api('/api/auth/login', 'POST', {
        email: document.getElementById('loginEmail').value,
        password: document.getElementById('loginPassword').value
    });
    
    btn.classList.remove('btn-loading');
    btn.disabled = false;
    
    if (res.success) {
        user = res.user;
        localStorage.setItem('user', JSON.stringify(user));
        showApp();
        toast('تم تسجيل الدخول');
    } else {
        toast(res.error || 'فشل الدخول', 'error');
    }
}

async function handleRegister(e) {
    e.preventDefault();
    const btn = document.getElementById('registerBtn');
    btn.classList.add('btn-loading');
    btn.disabled = true;
    
    const res = await api('/api/auth/register', 'POST', {
        username: document.getElementById('regUsername').value,
        email: document.getElementById('regEmail').value,
        password: document.getElementById('regPassword').value,
        referralCode: document.getElementById('regReferral').value
    });
    
    btn.classList.remove('btn-loading');
    btn.disabled = false;
    
    if (res.success) {
        user = res.user;
        localStorage.setItem('user', JSON.stringify(user));
        showApp();
        toast('تم إنشاء الحساب');
    } else {
        toast(res.error || 'فشل التسجيل', 'error');
    }
}

async function autoLogin() {
    // محاولة الدخول التلقائي بناءً على Device ID
    const res = await api('/api/auth/auto-login', 'POST', {});
    if (res.success) {
        user = res.user;
        localStorage.setItem('user', JSON.stringify(user));
        return true;
    }
    return false;
}

// App
async function showApp() {
    document.getElementById('authPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    updateUI();
    loadStats();
    loadCountries();
    
    // Admin check - يتم التحقق من وجود علامة الأدمن
    checkAdminStatus();
}

function checkAdminStatus() {
    // التحقق من وجود علامة الأدمن في التخزين المحلي
    // يتم وضعها عند فتح الرابط ?admin=true
    if (localStorage.getItem('isAdmin') === 'true') {
        document.getElementById('adminBtn').style.display = 'flex';
    }
}

// Pages
function showPage(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`${page}Page`).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach((n, i) => {
        const pages = ['home', 'buy', 'sell', 'numbers', 'wallet'];
        n.classList.toggle('active', pages[i] === page);
    });
    
    if (page === 'numbers') loadMyNumbers();
    if (page === 'admin') loadAdminDashboard();
    if (page === 'settings') document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
}

// Stats
async function loadStats() {
    const res = await api('/api/stats');
    if (res.availableNumbers !== undefined) {
        document.getElementById('statNumbers').textContent = res.availableNumbers;
        document.getElementById('statCountries').textContent = res.totalCountries;
        document.getElementById('depositAddr').textContent = res.depositWallet;
    }
}

// Countries
async function loadCountries() {
    const res = await api('/api/countries');
    if (res.success) {
        countries = res.countries;
        renderCountries('countriesList', countries);
        renderCountries('buyCountriesList', countries);
    }
}

function renderCountries(containerId, list) {
    const html = list.map(c => {
        const stockClass = c.stock === 0 ? 'empty' : c.stock < 10 ? 'low' : '';
        const disabled = c.stock === 0 ? 'disabled' : '';
        return `
            <div class="country-card ${disabled}" onclick="openBuyModal('${c.code}')">
                <img src="https://flagcdn.com/w80/${c.flag}.png" class="country-flag" onerror="this.src='https://via.placeholder.com/40'">
                <div class="country-info">
                    <div class="country-name">${c.name}</div>
                    <div class="country-meta">
                        <span>${c.phoneCode}</span>
                        <span class="country-stock ${stockClass}">${c.stock === 0 ? 'نفذ' : c.stock + ' متاح'}</span>
                    </div>
                </div>
                <div class="country-price">$${c.buyPrice.toFixed(2)}</div>
            </div>
        `;
    }).join('');
    document.getElementById(containerId).innerHTML = html;
}

function filterCountries() {
    const q = document.getElementById('searchCountry').value.toLowerCase();
    const filtered = countries.filter(c => c.name.includes(q) || c.phoneCode.includes(q));
    renderCountries('countriesList', filtered);
}

function filterBuyCountries() {
    const q = document.getElementById('searchBuy').value.toLowerCase();
    const filtered = countries.filter(c => c.name.includes(q) || c.phoneCode.includes(q));
    renderCountries('buyCountriesList', filtered);
}

// Buy
function openBuyModal(code) {
    selectedCountry = countries.find(c => c.code === code);
    if (!selectedCountry || selectedCountry.stock === 0) return;
    
    document.getElementById('buyFlag').src = `https://flagcdn.com/w160/${selectedCountry.flag}.png`;
    document.getElementById('buyCountryName').textContent = selectedCountry.name;
    document.getElementById('buyCountryCode').textContent = selectedCountry.phoneCode;
    document.getElementById('buyPrice').textContent = `$${selectedCountry.buyPrice.toFixed(2)}`;
    document.getElementById('buyBalance').textContent = `$${parseFloat(user?.balance || 0).toFixed(2)}`;
    
    openModal('buyModal');
}

async function confirmBuy() {
    if (!selectedCountry) return;
    const btn = document.getElementById('confirmBuyBtn');
    btn.classList.add('btn-loading');
    btn.disabled = true;
    
    const res = await api('/api/buy', 'POST', { country: selectedCountry.code });
    
    btn.classList.remove('btn-loading');
    btn.disabled = false;
    
    if (res.success) {
        closeModal('buyModal');
        user.balance = res.newBalance;
        localStorage.setItem('user', JSON.stringify(user));
        updateUI();
        toast(`تم شراء الرقم: ${res.phone}`);
        showPage('numbers');
        loadCountries();
    } else {
        toast(res.error || 'فشل الشراء', 'error');
    }
}

// Sell
async function sellSendCode() {
    const phone = document.getElementById('sellPhone').value.trim();
    if (!phone || !phone.startsWith('+')) {
        toast('أدخل رقم صحيح يبدأ بـ +', 'error');
        return;
    }
    
    const btn = document.getElementById('sellSendBtn');
    btn.classList.add('btn-loading');
    btn.disabled = true;
    
    const res = await api('/api/sell/send-code', 'POST', { phone });
    
    btn.classList.remove('btn-loading');
    btn.disabled = false;
    
    if (res.success) {
        sellPhoneNumber = phone;
        document.getElementById('sellStep1').style.display = 'none';
        document.getElementById('sellStep2').style.display = 'block';
        document.getElementById('sellInfo').textContent = `${res.countryName} - $${res.price.toFixed(2)}`;
        toast('تم إرسال الكود');
    } else {
        toast(res.error || 'فشل الإرسال', 'error');
    }
}

async function sellVerify() {
    const code = document.getElementById('sellCode').value.trim();
    if (!code) {
        toast('أدخل الكود', 'error');
        return;
    }
    
    const btn = document.getElementById('sellVerifyBtn');
    btn.classList.add('btn-loading');
    btn.disabled = true;
    
    const res = await api('/api/sell/verify', 'POST', {
        phone: sellPhoneNumber,
        code: code,
        password: document.getElementById('sell2FA').value || null
    });
    
    btn.classList.remove('btn-loading');
    btn.disabled = false;
    
    if (res.success) {
        toast('تم إرسال الطلب للمراجعة');
        // Reset
        document.getElementById('sellStep1').style.display = 'block';
        document.getElementById('sellStep2').style.display = 'none';
        document.getElementById('sellPhone').value = '';
        document.getElementById('sellCode').value = '';
        document.getElementById('sell2FA').value = '';
        document.getElementById('sell2FABox').style.display = 'none';
        showPage('wallet');
    } else if (res.error === '2FA_REQUIRED') {
        document.getElementById('sell2FABox').style.display = 'block';
        toast('أدخل كلمة مرور 2FA', 'warning');
    } else {
        toast(res.error || 'فشل التحقق', 'error');
    }
}

// My Numbers
async function loadMyNumbers() {
    const res = await api('/api/my-numbers');
    const container = document.getElementById('myNumbersList');
    
    if (res.success && res.numbers?.length > 0) {
        container.innerHTML = res.numbers.map(n => `
            <div class="purchase-card" onclick="openNumberModal('${n.id}')">
                <div class="purchase-header">
                    <div class="purchase-phone">${n.phone}</div>
                    <span class="purchase-status ${n.status}">${n.status === 'active' ? 'نشط' : 'مكتمل'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <small style="color: var(--text-secondary);">${n.country}</small>
                    <button class="btn btn-sm btn-secondary">عرض الرسائل</button>
                </div>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>لا توجد أرقام</p></div>';
    }
}

async function openNumberModal(id) {
    selectedPurchaseId = id;
    openModal('numberModal');
    document.getElementById('numberModalBody').innerHTML = '<div style="text-align:center;padding:2rem;"><div class="spinner"></div></div>';
    
    const res = await api(`/api/messages/${id}`);
    
    let html = '';
    if (res.success && res.messages?.length > 0) {
        html = res.messages.map(m => `
            <div class="message-item">
                <div class="message-code">${m.code}</div>
                <button class="btn btn-sm btn-secondary" onclick="copyText('${m.code}')"><i class="fas fa-copy"></i></button>
            </div>
        `).join('');
    } else {
        html = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> لا توجد رسائل بعد</div>';
    }
    
    html += `
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="openNumberModal('${id}')"><i class="fas fa-sync"></i> تحديث</button>
            <button class="btn btn-success" onclick="completeNumber('${id}')"><i class="fas fa-check"></i> إنهاء</button>
        </div>
    `;
    
    document.getElementById('numberModalBody').innerHTML = html;
}

async function completeNumber(id) {
    const res = await api('/api/complete', 'POST', { purchaseId: id });
    if (res.success) {
        closeModal('numberModal');
        toast('تم إنهاء الرقم');
        loadMyNumbers();
    }
}

// Deposit
function copyDeposit() {
    copyText(document.getElementById('depositAddr').textContent);
}

async function submitDeposit() {
    const txid = document.getElementById('depositTxid').value.trim();
    if (!txid || txid.length < 60) {
        toast('أدخل TXID صحيح', 'error');
        return;
    }
    
    const btn = document.getElementById('depositBtn');
    btn.classList.add('btn-loading');
    btn.disabled = true;
    
    const res = await api('/api/deposit', 'POST', { txid });
    
    btn.classList.remove('btn-loading');
    btn.disabled = false;
    
    if (res.success) {
        closeModal('depositModal');
        user.balance = res.newBalance;
        localStorage.setItem('user', JSON.stringify(user));
        updateUI();
        toast(`تم إيداع $${res.amount.toFixed(2)}`);
        document.getElementById('depositTxid').value = '';
    } else if (res.error === 'manual_review') {
        closeModal('depositModal');
        toast('سيتم مراجعة إيداعك وإضافة الرصيد قريباً', 'warning');
        document.getElementById('depositTxid').value = '';
    } else {
        toast(res.error || 'فشل التحقق', 'error');
    }
}

// Withdraw
async function submitWithdraw() {
    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    const address = document.getElementById('withdrawAddress').value.trim();
    
    if (!amount || amount < 3) {
        toast('الحد الأدنى $3', 'error');
        return;
    }
    if (!address || address.length !== 42) {
        toast('عنوان غير صحيح', 'error');
        return;
    }
    
    const btn = document.getElementById('withdrawBtn');
    btn.classList.add('btn-loading');
    btn.disabled = true;
    
    const res = await api('/api/withdraw', 'POST', { amount, address });
    
    btn.classList.remove('btn-loading');
    btn.disabled = false;
    
    if (res.success) {
        closeModal('withdrawModal');
        user.balance = res.newBalance;
        localStorage.setItem('user', JSON.stringify(user));
        updateUI();
        toast('تم إرسال طلب السحب');
        document.getElementById('withdrawAmount').value = '';
        document.getElementById('withdrawAddress').value = '';
    } else {
        toast(res.error || 'فشل', 'error');
    }
}

// Referral
function copyReferral() {
    const link = `${location.origin}?ref=${user?.referralCode || ''}`;
    copyText(link);
}

// Admin
async function loadAdminDashboard() {
    const res = await api('/api/admin/dashboard');
    if (res.success) {
        document.getElementById('adminUsers').textContent = res.stats.totalUsers;
        document.getElementById('adminNumbers').textContent = res.stats.availableNumbers;
        document.getElementById('adminSells').textContent = res.stats.pendingSells;
        document.getElementById('adminWithdrawals').textContent = res.stats.pendingWithdrawals;
        document.getElementById('adminDeposits').textContent = res.stats.pendingDeposits || 0;
    }
}

async function loadAdminSection(section) {
    const content = document.getElementById('adminContent');
    content.innerHTML = '<div style="text-align:center;padding:2rem;"><div class="spinner"></div></div>';
    
    if (section === 'users') {
        const res = await api('/api/admin/users');
        if (res.success) {
            content.innerHTML = res.users.map(u => `
                <div class="settings-item" style="cursor: default;">
                    <div class="settings-info">
                        <div class="settings-icon"><i class="fas fa-user"></i></div>
                        <div>
                            <div>${u.username}</div>
                            <small style="color:var(--text-secondary);">${u.email} | $${parseFloat(u.balance||0).toFixed(2)}</small>
                        </div>
                    </div>
                    <div style="display:flex;gap:0.25rem;">
                        <button class="btn btn-sm ${u.banned ? 'btn-success' : 'btn-danger'}" onclick="${u.banned ? `unbanUser('${u.id}')` : `banUser('${u.id}')`}">${u.banned ? 'فك' : 'حظر'}</button>
                        <button class="btn btn-sm btn-secondary" onclick="addUserBalance('${u.id}')">+$</button>
                    </div>
                </div>
            `).join('');
        }
    } else if (section === 'sells') {
        const res = await api('/api/admin/sells');
        if (res.success) {
            content.innerHTML = res.items.length === 0 ? '<div class="empty-state"><p>لا توجد طلبات</p></div>' : res.items.map(s => `
                <div class="settings-item" style="cursor: default;">
                    <div class="settings-info">
                        <div class="settings-icon"><i class="fas fa-phone"></i></div>
                        <div>
                            <div dir="ltr">${s.phone}</div>
                            <small style="color:var(--text-secondary);">${s.username} | $${s.price}</small>
                        </div>
                    </div>
                    <div style="display:flex;gap:0.25rem;">
                        <button class="btn btn-sm btn-success" onclick="approveSell('${s.id}')">قبول</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectSell('${s.id}')">رفض</button>
                    </div>
                </div>
            `).join('');
        }
    } else if (section === 'withdrawals') {
        const res = await api('/api/admin/withdrawals');
        if (res.success) {
            const pending = res.items.filter(w => w.status === 'pending');
            content.innerHTML = pending.length === 0 ? '<div class="empty-state"><p>لا توجد طلبات</p></div>' : pending.map(w => `
                <div class="settings-item" style="cursor: default;">
                    <div class="settings-info">
                        <div class="settings-icon"><i class="fas fa-money-bill"></i></div>
                        <div>
                            <div>$${w.amount} - ${w.username}</div>
                            <small style="color:var(--text-secondary);word-break:break-all;">${w.address}</small>
                        </div>
                    </div>
                    <div style="display:flex;gap:0.25rem;">
                        <button class="btn btn-sm btn-success" onclick="approveWithdraw('${w.id}')">تم</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectWithdraw('${w.id}')">رفض</button>
                    </div>
                </div>
            `).join('');
        }
    } else if (section === 'deposits') {
        const res = await api('/api/admin/pending-deposits');
        if (res.success) {
            content.innerHTML = res.items.length === 0 ? '<div class="empty-state"><p>لا توجد إيداعات معلقة</p></div>' : res.items.map(d => `
                <div class="settings-item" style="cursor: default;">
                    <div class="settings-info">
                        <div class="settings-icon"><i class="fas fa-plus-circle"></i></div>
                        <div>
                            <div>${d.username}</div>
                            <small style="color:var(--text-secondary);word-break:break-all;">${d.txid.slice(0,20)}...</small>
                        </div>
                    </div>
                    <div style="display:flex;gap:0.25rem;">
                        <button class="btn btn-sm btn-success" onclick="approveDeposit('${d.id}')">قبول</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectDeposit('${d.id}')">رفض</button>
                    </div>
                </div>
            `).join('');
        }
    } else if (section === 'addNumber') {
        content.innerHTML = `
            <div class="form-group">
                <label class="form-label">رقم الهاتف</label>
                <input type="tel" class="form-input" id="adminPhone" placeholder="+966..." dir="ltr">
            </div>
            <button class="btn btn-primary" onclick="adminSendCode()">إرسال الكود</button>
            <div id="adminCodeStep" style="display:none;margin-top:1rem;">
                <div class="form-group">
                    <label class="form-label">الكود</label>
                    <input type="text" class="form-input" id="adminCode" dir="ltr">
                </div>
                <div class="form-group" id="admin2FA" style="display:none;">
                    <label class="form-label">كلمة مرور 2FA</label>
                    <input type="password" class="form-input" id="admin2FAPass">
                </div>
                <button class="btn btn-success" onclick="adminVerify()">تأكيد وإضافة</button>
            </div>
        `;
    } else if (section === 'numbers') {
        const res = await api('/api/admin/numbers');
        if (res.success) {
            const available = res.items.filter(n => n.status === 'available');
            content.innerHTML = available.length === 0 ? '<div class="empty-state"><p>لا توجد أرقام</p></div>' : available.map(n => `
                <div class="settings-item" style="cursor: default;">
                    <div class="settings-info">
                        <div class="settings-icon"><i class="fas fa-phone"></i></div>
                        <div dir="ltr">${n.phone}</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteNumber('${n.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }
    }
}

// Admin Actions
async function banUser(id) {
    const reason = prompt('سبب الحظر:');
    if (reason !== null) {
        await api(`/api/admin/user/${id}/ban`, 'POST', { reason });
        loadAdminSection('users');
    }
}

async function unbanUser(id) {
    await api(`/api/admin/user/${id}/unban`, 'POST');
    loadAdminSection('users');
}

async function addUserBalance(id) {
    const amount = prompt('المبلغ:');
    if (amount) {
        await api(`/api/admin/user/${id}/add-balance`, 'POST', { amount: parseFloat(amount) });
        loadAdminSection('users');
    }
}

async function approveSell(id) {
    await api('/api/admin/approve-sell', 'POST', { id });
    toast('تم القبول');
    loadAdminSection('sells');
    loadAdminDashboard();
}

async function rejectSell(id) {
    await api('/api/admin/reject-sell', 'POST', { id });
    toast('تم الرفض');
    loadAdminSection('sells');
}

async function approveWithdraw(id) {
    const txid = prompt('TXID:');
    if (txid) {
        await api('/api/admin/approve-withdrawal', 'POST', { id, txid });
        toast('تم');
        loadAdminSection('withdrawals');
        loadAdminDashboard();
    }
}

async function rejectWithdraw(id) {
    await api('/api/admin/reject-withdrawal', 'POST', { id, reason: 'رفض' });
    toast('تم الرفض');
    loadAdminSection('withdrawals');
}

async function approveDeposit(id) {
    const amount = prompt('المبلغ:');
    if (amount) {
        await api('/api/admin/approve-deposit', 'POST', { id, amount: parseFloat(amount) });
        toast('تم');
        loadAdminSection('deposits');
        loadAdminDashboard();
    }
}

async function rejectDeposit(id) {
    await api('/api/admin/reject-deposit', 'POST', { id });
    toast('تم الرفض');
    loadAdminSection('deposits');
}

async function deleteNumber(id) {
    if (confirm('حذف؟')) {
        await api('/api/admin/delete-number', 'POST', { id });
        loadAdminSection('numbers');
    }
}

let adminPhoneTemp = '';
async function adminSendCode() {
    const phone = document.getElementById('adminPhone').value.trim();
    const res = await api('/api/admin/add-send-code', 'POST', { phone });
    if (res.success) {
        adminPhoneTemp = phone;
        document.getElementById('adminCodeStep').style.display = 'block';
        toast('تم إرسال الكود');
    } else {
        toast(res.error || 'فشل', 'error');
    }
}

async function adminVerify() {
    const code = document.getElementById('adminCode').value.trim();
    const password = document.getElementById('admin2FAPass')?.value || null;
    
    const res = await api('/api/admin/add-verify', 'POST', {
        phone: adminPhoneTemp,
        code,
        password
    });
    
    if (res.success) {
        toast('تم إضافة الرقم');
        loadAdminSection('numbers');
        loadAdminDashboard();
    } else if (res.error === '2FA_REQUIRED') {
        document.getElementById('admin2FA').style.display = 'block';
        toast('أدخل 2FA', 'warning');
    } else {
        toast(res.error || 'فشل', 'error');
    }
}

// Delete All Data
function confirmDeleteAll() {
    openModal('deleteModal');
    document.getElementById('deleteConfirmInput').value = '';
}

async function executeDeleteAll() {
    const input = document.getElementById('deleteConfirmInput').value;
    if (input !== 'DELETE') {
        toast('اكتب DELETE للتأكيد', 'error');
        return;
    }
    
    const res = await api('/api/admin/delete-all', 'POST', { confirm: 'DELETE_ALL_DATA' });
    if (res.success) {
        closeModal('deleteModal');
        toast('تم حذف جميع البيانات');
        localStorage.clear();
        location.reload();
    } else {
        toast(res.error || 'فشل الحذف', 'error');
    }
}

// Device Info
function showDeviceInfo() {
    alert(`Device ID: ${deviceId}\n\nهذا المعرف ثابت ويُستخدم لربط حسابك بجهازك.`);
}

// Modal
function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

// Copy
function copyText(text) {
    navigator.clipboard.writeText(text);
    toast('تم النسخ');
}

// Check referral in URL
function checkReferral() {
    const params = new URLSearchParams(location.search);
    const ref = params.get('ref');
    if (ref) {
        document.getElementById('regReferral').value = ref;
        switchAuthTab('register');
    }
}

// Init
async function init() {
    checkReferral();
    
    // ✅ الإصلاح: التحقق من رابط الأدمن وتخزينه بشكل دائم
    if (window.location.search.includes('admin=true')) {
        localStorage.setItem('isAdmin', 'true');
        // تنظيف الرابط للأمان (اختياري)
        if (window.history.replaceState) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
    
    const loggedIn = await autoLogin();
    
    setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('hidden');
    }, 300);
    
    if (loggedIn) {
        showApp();
    } else {
        document.getElementById('authPage').style.display = 'block';
    }
}

// Auto refresh
setInterval(async () => {
    if (user) {
        const res = await api('/api/auth/me');
        if (res.success) {
            user = { ...user, ...res.user };
            localStorage.setItem('user', JSON.stringify(user));
            updateUI();
        }
    }
}, 30000);

// Start
init();

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => {
        if (e.target === m) m.classList.remove('active');
    });
});
</script>
</body>
</html>
